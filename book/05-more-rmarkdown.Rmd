---
output:
  html_document:
    toc: 2
---
# More Rmarkdown

We are going to inrease the difficulty a little now. We are going to start working towards our [final documnet](example.html).

Typically you will have some data set that you are trying to analyse. There are likely to be some other prior steps before you get your tabular data. Those prior steps should also be documented. In this workshop we are going to start with a tabular data set. I found this rather interesting data set at [data.gov.au](https://data.gov.au), [Domestic Airlines - On Time Performance](https://data.gov.au/data/dataset/domestic-airline-on-time-performance) and I decided to investigate it a bit closer.

## Setup

First thing first is we need to download it. Note that `read_csv` from [`readr`](https://readr.tidyverse.org/) package can "read" directly from url, but I wasn't sure if everytime I compile Rmarkdown to html it would re-download the file or use chached version. I decide to store a local copy on my computer for speed and simplisity. You should always check a licence on the data set, especially if you are going to publish some of your analysis. This data is _Creative Commons Attribution 3.0 Australia_  licence, there is no problem in downloading and using the data.


Let's open new Rmarkdown file and delete everything from it except the yaml header.

### Setting global chunk options

As you have learned already you can manipulate each R chunk with options, but you can also set global settings for each chunk. Let's set `echo = TRUE` and `message = FALSE` globaly. This means every R chunk will be echoed i.e shown in the finale document and no messages will appear anywhere in the document.

```{r setup}
options(encoding="utf-8")

knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE)
```

### Loading libraries

We are going to do our analysis with the help of [`tidyverse`](https://www.tidyverse.org/) library, that in itself includes many other libraries.


```{r}
library(tidyverse)
```

### Downloading the data

We are doing conditional download here, don't re-download if we already have the file.

```{r}
fn_data <- "domestic_airline_performance.csv"
fn_notes <- "domestic_airline_performance_notes.txt"

if(!file.exists(fn_data)) {
  url_data <- "https://data.gov.au/data/dataset/29128ebd-dbaa-4ff5-8b86-d9f30de56452/resource/cf663ed1-0c5e-497f-aea9-e74bfda9cf44/download/otp_time_series_web.csv"
  url_notes <- "https://data.gov.au/data/dataset/29128ebd-dbaa-4ff5-8b86-d9f30de56452/resource/69e214b9-b66f-4636-9c84-3efda2d0d8ae/download/otptimeserieswebnotes.txt"

  download.file(url_data, fn_data)
  download.file(url_notes, fn_notes)
}

df <- read_csv(fn_data, quote = "")
df
```

## Challenge: 1 {.exercise}

> 2 minutes

<details>

  <summary>
    1. Exploring and familiarising yourself with the data set
  </summary>
  ```{r child="domestic_airline_performance_notes.txt"}

  ```
</details>


## Exploring the data

Now that we've got the data lets explore it. It always helps if we can find more information about the data set, particular what information each column might have.

Let's understand a bit better the number of columns and rows that we are dealing with

```{r}
df %>% dim
```

The reason I'm going to converted to `data.frame` is simply becasue I want to see one entry per line

```{r warning=F}
df %>%
  colnames %>%
  unlist %>%
  sort %>%
  data.frame
```

There are many ways you can explore this data, but i just want to have a look at the types of Airlines there are.

```{r}
df %>%
  select(Airline) %>%
  distinct() %>%
  arrange(Airline)
```

## Cleaning up

I've noticed that there "All Airlines" name in the `Airline` column that appears to have the most number of occurrences in the data

```{r}
df %>%
  group_by(Airline) %>%
  summarise(n = n()) %>%
  arrange(-n)
```

Also there one of the routes is `All Ports-All Ports`. Googling for that name didn't reveal any places in Australia by that name.

```{r}
df %>%
  group_by(Route) %>%
  summarise(n = n()) %>%
  arrange(-n)
```

I decide going forward to drop those data points.

```{r}
df2 <- df %>%
          filter(Airline != "All Airlines",
                 Route != "All Ports-All Ports")
```


## Visualising the data

### Bar plot

```{r}
df2 %>%
  group_by(Airline, Route) %>%
  summarise(n = n()) %>%
  ungroup %>%
  ggplot(aes(Route, n)) +
    geom_bar(stat = 'identity') +
    facet_wrap(~Airline, ncol = 5, scales = "free_y") +
    theme(axis.text.x=element_text(angle=45, hjust=1))
```

### Scatter plot

```{r}
p2 <- df2 %>%
  group_by(Airline, Year, Departing_Port, Arriving_Port) %>%
  summarise(n = n()) %>%
  ungroup %>%
  ggplot(aes(Departing_Port, Arriving_Port, color = factor(Year))) +
    geom_point(aes(size = n)) +
    facet_wrap(~Airline, ncol = 5, scales = "free") +
    theme(axis.text.x=element_text(angle=45, hjust=1))

p2
```

```{r}
p3 <- df2 %>%
        select(Airline, Route, Cancellations, Year, Month_Num) %>%
        ggplot(aes(factor(Year), Cancellations, color = Airline)) +
          geom_point() +
          facet_wrap(~Airline, ncol = 5) +
          theme(axis.text.x=element_text(angle= 45, hjust=1))
p3
```

```{r}

k <- 10

p4 <- df2 %>%
        select(Airline, Route, Cancellations, Year, Month_Num) %>%
        group_by(Airline, Year) %>%
        mutate(tot = n()) %>%
        ungroup %>%
        mutate(norm_cancel = (Cancellations/tot) * k) %>%
        ggplot(aes(factor(Year), norm_cancel, color = Airline)) +
          geom_point() +
          facet_wrap(~Airline, ncol = 5) +
          theme(axis.text.x=element_text(angle=45, hjust=1))
p4
```

It appears that after normalising for number of flights in that year by a particular Airline that Virgin Aus, ATR has the higest number of cancellations.

Need to check but I think the intepretation of the my normalisation is that for every 10 flights 6 are cancelled

## Next step

Learn from the data which airlines appear to be departing/arrivign late and to which destinations

## References

- [themes](http://www.datadreaming.org/post/r-markdown-theme-gallery/)
